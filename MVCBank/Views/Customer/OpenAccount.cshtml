@{
    ViewBag.Title = "Open Account";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<h2>Open an Account</h2>

@if (TempData["Message"] != null)
{
    <div class="alert alert-info">@TempData["Message"]</div>
}

<div class="mb-3" style="max-width:600px;">
    <label class="form-label">Select Account Type</label>
    <select id="accountType" class="form-control">
        <option value="SAVINGS">Savings Account</option>
        <option value="FD">Fixed Deposit</option>
        <option value="LOAN">Loan Account</option>
    </select>
</div>

<form method="post" action="@Url.Action("OpenAccount", "Customer")" id="openAccountForm">
    @Html.AntiForgeryToken()

    <div id="savingsForm" class="account-form">
        <h4>Savings Account</h4>
        <div class="mb-3">
            <label for="initialDeposit" class="form-label">Initial Deposit (minimum 1000)</label>
            <input type="number" step="0.01" min="1000" name="initialDeposit" class="form-control" id="initialDeposit" />
        </div>
    </div>

    <div id="fdForm" class="account-form" style="display:none;">
        <h4>Fixed Deposit</h4>
        <div class="mb-3">
            <label for="fdAmount" class="form-label">Deposit Amount (minimum 10000)</label>
            <input type="number" step="0.01" min="10000" name="fdAmount" class="form-control" id="fdAmount" />
        </div>
        <div class="mb-3">
            <label for="fdDuration" class="form-label">Duration (months)</label>
            <input type="number" min="1" name="fdDuration" class="form-control" id="fdDuration" />
        </div>
        <div class="mb-3">
            <label for="fdROI" class="form-label">Interest Rate (e.g. 6.5)</label>
            <input type="number" step="0.01" min="0" name="fdROI" class="form-control" id="fdROI" />
        </div>
    </div>

    <div id="loanForm" class="account-form" style="display:none;">
        <h4>Loan Account</h4>
        <div class="mb-3">
            <label for="loanAmount" class="form-label">Loan Amount (minimum 10000)</label>
            <input type="number" step="0.01" min="10000" name="loanAmount" class="form-control" id="loanAmount" />
        </div>
        <div class="mb-3">
            <label for="loanTenure" class="form-label">Tenure (months)</label>
            <input type="number" min="1" name="loanTenure" class="form-control" id="loanTenure" />
        </div>
        <div class="mb-3">
            <label for="monthlyTakeHome" class="form-label">Monthly Take Home</label>
            <input type="number" step="0.01" min="0" name="monthlyTakeHome" class="form-control" id="monthlyTakeHome" />
        </div>
        <div id="emiWarning" class="alert alert-warning" style="display:none;max-width:600px;"></div>
        <div id="emiInfo" class="alert alert-info" style="display:none;max-width:600px;"></div>
    </div>

    <input type="hidden" name="accountTypeSelected" id="accountTypeSelected" value="SAVINGS" />
    <br />
    <button type="submit" class="btn btn-primary">Submit</button>
</form>

<script>
    (function(){
        var sel = document.getElementById('accountType');
        var savings = document.getElementById('savingsForm');
        var fd = document.getElementById('fdForm');
        var loan = document.getElementById('loanForm');
        var hidden = document.getElementById('accountTypeSelected');

        var loanAmount = document.getElementById('loanAmount');
        var loanTenure = document.getElementById('loanTenure');
        var monthlyTakeHome = document.getElementById('monthlyTakeHome');
        var emiWarning = document.getElementById('emiWarning');
        var emiInfo = document.getElementById('emiInfo');
        var form = document.getElementById('openAccountForm');

        function toggle(){
            var v = sel.value;
            savings.style.display = v === 'SAVINGS' ? '' : 'none';
            fd.style.display = v === 'FD' ? '' : 'none';
            loan.style.display = v === 'LOAN' ? '' : 'none';
            hidden.value = v;
        }

        sel.addEventListener('change', toggle);
        toggle();

        function computeEMI() {
            var amount = parseFloat(loanAmount.value) || 0;
            var tenure = parseInt(loanTenure.value) || 0;
            var takeHome = parseFloat(monthlyTakeHome.value) || 0;
            // ROI slabs
            var roi = 0.10;
            if(amount > 1000000) roi = 0.09;
            else if(amount >= 500000) roi = 0.095;

            var r = roi/12;
            var n = tenure;
            var emi = n > 0 ? (amount * r * Math.pow(1+r, n)) / (Math.pow(1+r, n)-1) : 0;

            if(takeHome > 0 && emi > takeHome * 0.6) {
                emiWarning.style.display = '';
                emiWarning.innerText = 'EMI exceeds 60% of Monthly Take Home. Please adjust values.';
            } else {
                emiWarning.style.display = 'none';
            }

            if(amount >= 10000 && tenure > 0) {
                emiInfo.style.display = '';
                emiInfo.innerHTML = '<strong>Estimated EMI:</strong> ' + emi.toFixed(2)
                    + ' | <strong>ROI:</strong> ' + (roi*100).toFixed(2) + '%';
            } else {
                emiInfo.style.display = 'none';
            }
        }

        loanAmount && loanAmount.addEventListener('input', computeEMI);
        loanTenure && loanTenure.addEventListener('input', computeEMI);
        monthlyTakeHome && monthlyTakeHome.addEventListener('input', computeEMI);

        form.addEventListener('submit', function(e){
            if(hidden.value === 'LOAN'){
                var amount = parseFloat(loanAmount.value) || 0;
                var tenure = parseInt(loanTenure.value) || 0;
                var takeHome = parseFloat(monthlyTakeHome.value) || 0;
                if(amount < 10000){ alert('Minimum Loan amount is Rs. 10,000'); e.preventDefault(); return false; }
                if(tenure <= 0){ alert('Loan tenure (months) is required.'); e.preventDefault(); return false; }
                if(takeHome <= 0){ alert('Monthly take home is required.'); e.preventDefault(); return false; }
                var roi = 0.10; if(amount > 1000000) roi = 0.09; else if(amount >= 500000) roi = 0.095;
                var r = roi/12; var n = tenure; var emi = n > 0 ? (amount * r * Math.pow(1+r, n)) / (Math.pow(1+r, n)-1) : 0;
                if(takeHome > 0 && emi > takeHome * 0.6){ alert('EMI exceeds 60% of Monthly Take Home. Please adjust values.'); e.preventDefault(); return false; }
            }
        });
    })();
</script>